#Starting R studio

#FEAST
library(FEAST)
library(Rcpp)
library(RcppArmadillo)
library(vegan)
library(dplyr)
library(reshape2)
library(gridExtra)
library(ggplot2)
library(ggthemes)
library(doParallel)
library(foreach)
library(mgcv)
library(cowplot)
library(ggrepel)

EM_iterations = 1000

metadata<-read.csv("metadata.csv",row.names=1)
otus<-read.csv("otus.csv",row.names=1)
otus <- t(as.matrix(otus))
common.sample.ids <-intersect(rownames(metadata), rownames(otus))
otus <- otus[common.sample.ids,]
metadata <-metadata[common.sample.ids,]
envs <- metadata$Env
Ids <-na.omit(unique(metadata$id))
different_sources_flag <- 0
for(it in 1:length(Ids)){
  if(different_sources_flag == 1){
    train.ix <- which(metadata$SourceSink=='Source' & metadata$id ==Ids[it])
    test.ix <- which(metadata$SourceSink=='Sink' & metadata$id ==Ids[it])
  } else {
      train.ix <- which(metadata$SourceSink=='Source')
      test.ix <- which(metadata$SourceSink=='Sink' & metadata$id ==Ids[it])
      }
}
print(train.ix)
print(test.ix)
num_sources <- length(train.ix)
COVERAGE = min(rowSums(otus[c(train.ix, test.ix),]))
str(COVERAGE)
sources <-as.data.frame(as.matrix(rarefy(as.data.frame(otus[train.ix,]), COVERAGE)))
sinks <-as.data.frame(as.matrix(rarefy(as.data.frame(t(as.matrix(otus[test.ix,]))),COVERAGE)))
print(paste("Number of OTUs in the sink sample =",length(which(sinks > 0))))
print(paste("The sink is:", envs[test.ix]))
# Estimate source proportions for each sink
FEAST_output<-FEAST(source=sources, sinks = t(sinks), env =envs[train.ix], em_itr = EM_iterations, COVERAGE = COVERAGE)


